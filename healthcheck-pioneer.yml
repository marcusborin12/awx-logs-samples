---
- name: Health Check Dynatrace ‚Äì Infra, Application e Services
  hosts: localhost
  gather_facts: no

  vars:
    dynatrace_url: "{{ DT_TENANT_URL }}"
    dynatrace_token: "{{ DT_API_TOKEN }}"

    infra_tag: "INFRA"
    app_tag: "APP"
    service_tag: "SERVICE"

  tasks:

    - name: Validar vari√°veis obrigat√≥rias
      fail:
        msg: "dynatrace_url ou dynatrace_token n√£o configurados."
      when: dynatrace_url == "" or dynatrace_token == ""

    #################################################################
    # 1) HEALTH INFRA  
    #################################################################
    - name: Consultar Infraestrutura com tag
      uri:
        url: "{{ dynatrace_url }}/api/v2/entities?entitySelector=type(HOST),tag({{ infra_tag }})"
        method: GET
        headers:
          Authorization: "Api-Token {{ dynatrace_token }}"
        return_content: yes
        status_code: 200
        validate_certs: yes
      register: infra_response

    - name: Processar sa√∫de dos hosts
      set_fact:
        infra_health: "{{ (infra_response.json.items | default([]) | map(attribute='healthState') | list) }}"

    #################################################################
    # 2) HEALTH APPLICATION
    #################################################################
    - name: Consultar Aplica√ß√µes com tag
      uri:
        url: "{{ dynatrace_url }}/api/v2/entities?entitySelector=type(APPLICATION),tag({{ app_tag }})"
        method: GET
        headers:
          Authorization: "Api-Token {{ dynatrace_token }}"
        return_content: yes
        status_code: 200
        validate_certs: yes
      register: app_response

    - name: Processar sa√∫de das aplica√ß√µes
      set_fact:
        app_health: "{{ (app_response.json.items | default([]) | map(attribute='healthState') | list) }}"

    #################################################################
    # 3) HEALTH SERVICES
    #################################################################
    - name: Consultar Servi√ßos com tag
      uri:
        url: "{{ dynatrace_url }}/api/v2/entities?entitySelector=type(SERVICE),tag({{ service_tag }})"
        method: GET
        headers:
          Authorization: "Api-Token {{ dynatrace_token }}"
        return_content: yes
        status_code: 200
        validate_certs: yes
      register: service_response

    - name: Processar sa√∫de dos servi√ßos
      set_fact:
        service_health: "{{ (service_response.json.items | default([]) | map(attribute='healthState') | list) }}"

    #################################################################
    # 4) CHECAR PROBLEMAS ABERTOS
    #################################################################
    - name: Consultar problemas abertos no Dynatrace
      uri:
        url: "{{ dynatrace_url }}/api/v2/problems"
        method: GET
        headers:
          Authorization: "Api-Token {{ dynatrace_token }}"
        return_content: yes
        status_code: 200
        validate_certs: yes
      register: problems_response

    - name: Processar problemas abertos
      set_fact:
        open_problems: "{{ problems_response.json.totalCount | default(0) }}"

    #################################################################
    # 5) SUMMARY FINAL
    #################################################################
    - name: Gerar Summary do Health Check
      set_fact:
        health_summary: |
          üîç **Health Check Dynatrace**
          ---
          üñ• **Infraestrutura (Hosts com tag {{ infra_tag }})**
          Statuses: {{ infra_health }}

          üåê **Aplica√ß√µes (tag {{ app_tag }})**
          Statuses: {{ app_health }}

          üîß **Servi√ßos (tag {{ service_tag }})**
          Statuses: {{ service_health }}

          üö® **Problemas Abertos:** {{ open_problems }}

    - name: Exibir Summary Final
      debug:
        msg: "{{ health_summary }}"
